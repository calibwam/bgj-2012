function ParticleSystem(){
    this.MAX_PARTICLES = 256;
    this.MAX_ATTRACTORS = 8;

    this.particles = [];
    for(var i=0;i<this.MAX_PARTICLES;i++){
        this.particles[i] = new Particle();
    }
    this.num_active_particles = 0;

    this.attractors = [];
    for(var i=0;i<this.MAX_ATTRACTORS;i++){
        this.attractors[i] = new ParticleAttractor();
    }
    this.num_active_attractors = 0;
}

ParticleSystem.prototype.addParticle = function(x,y,dx,dy){
    if(this.num_active_particles >= this.MAX_PARTICLES) return;
    var p = this.particles[this.num_active_particles++];
    p.x = x;
    p.y = y;
    p.dx = dx||0;
    p.dy = dy||0;
}

ParticleSystem.prototype.removeParticle = function(i){
    this.copyParticle(this.particles[this.num_active_particles--], this.particles[i]);
}

ParticleSystem.prototype.copyParticle = function(from, to){
    to.x = from.x;
    to.y = from.y;
    to.w = from.w;
    to.h = from.h;
    to.dx = from.dx;
    to.dy = from.dy;
}

ParticleSystem.prototype.addAttractor = function(x,y,m){ 
    if(this.num_active_attractors >= this.MAX_ATTRACTORS) return;
    var a = this.attractors[this.num_active_attractors++];
    a.x = x;
    a.y = y;
    a.m = m;
}

ParticleSystem.prototype.removeAttractor = function(i){
    this.copyAttractor(this.attractors[this.num_active_attractors--], this.attractors[i]);
}

ParticleSystem.prototype.copyAttractor = function(from, to){
    to.x = from.x;
    to.y = from.y;
    to.m = from.m;
}

ParticleSystem.prototype.render = function(ctx){
    for(var i=0;i<this.num_active_particles;i++){
        this.particles[i].render(ctx);
    }
    for(var i=0;i<this.num_active_attractors;i++){
        this.attractors[i].render(ctx);
    }
}

ParticleSystem.prototype.update = function(){
    for(var i=0;i<this.num_active_attractors;i++){
        var a = this.attractors[i];
        for(var j=0;j<this.num_active_particles;j++){
            var p = this.particles[i];
            var rx = a.x-p.x;
            var ry = a.y-p.y;
            p.dx = rx/Math.abs(rx)*p.dx+0.001*a.m/(rx*rx);
            p.dy = ry/Math.abs(ry)*p.dy+0.001*a.m/(ry*ry);
        }
    }
    for(var i=0;i<this.num_active_particles;i++){
        this.particles[i].update();
    }
}
